{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "User Profile API Contract",
  "description": "API Contract for Agent Beta. Defines the response shape for user profile endpoints.",
  "version": "1.0.0",
  "lastUpdated": "2024-12-10",
  "author": "Agent Alpha",

  "endpoints": {
    "GET /api/v1/users/:id": {
      "description": "Retrieve a user profile by ID",
      "auth": "Optional (public endpoint for leaderboard)",
      "params": {
        "id": {
          "type": "string",
          "format": "uuid",
          "required": true,
          "description": "User's UUID (matches auth.users.id)"
        }
      },
      "response": {
        "200": {
          "description": "Profile found",
          "schema": { "$ref": "#/definitions/Profile" }
        },
        "404": {
          "description": "Profile not found",
          "schema": {
            "type": "object",
            "properties": {
              "error": { "type": "string", "example": "Profile not found" },
              "code": { "type": "string", "example": "PROFILE_NOT_FOUND" }
            }
          }
        }
      }
    },

    "PATCH /api/v1/users/:id": {
      "description": "Update a user's own profile",
      "auth": "Required (Bearer token). User can only update their own profile.",
      "params": {
        "id": {
          "type": "string",
          "format": "uuid",
          "required": true
        }
      },
      "requestBody": {
        "schema": { "$ref": "#/definitions/ProfileUpdate" }
      },
      "response": {
        "200": {
          "description": "Profile updated successfully",
          "schema": { "$ref": "#/definitions/Profile" }
        },
        "401": {
          "description": "Unauthorized",
          "schema": {
            "type": "object",
            "properties": {
              "error": { "type": "string" },
              "code": { "type": "string", "example": "UNAUTHORIZED" }
            }
          }
        },
        "403": {
          "description": "Forbidden (not own profile)",
          "schema": {
            "type": "object",
            "properties": {
              "error": { "type": "string" },
              "code": { "type": "string", "example": "FORBIDDEN" }
            }
          }
        }
      }
    },

    "GET /api/v1/streaks/leaderboard": {
      "description": "Get top users by consistency score",
      "auth": "Optional",
      "queryParams": {
        "limit": {
          "type": "integer",
          "default": 10,
          "max": 100,
          "description": "Number of profiles to return"
        },
        "offset": {
          "type": "integer",
          "default": 0,
          "description": "Pagination offset"
        }
      },
      "response": {
        "200": {
          "schema": {
            "type": "object",
            "properties": {
              "leaderboard": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                     "user_id": { "type": "string", "format": "uuid" },
                     "display_name": { "type": "string" },
                     "avatar_url": { "type": ["string", "null"] },
                     "current_streak": { "type": "integer" },
                     "consistency_score": { "type": "integer" },
                     "rank": { "type": "integer" }
                  }
                }
              }
            }
          }
        }
      }
    }
  },

  "definitions": {
    "Profile": {
      "type": "object",
      "properties": {
        "id": {
          "type": "string",
          "format": "uuid",
          "description": "Unique identifier (matches Supabase Auth user ID)"
        },
        "username": {
          "type": "string",
          "description": "Unique display name"
        },
        "full_name": {
          "type": ["string", "null"],
          "description": "User's real name (optional)"
        },
        "avatar_url": {
          "type": ["string", "null"],
          "format": "uri",
          "description": "Profile picture URL (optional)"
        },
        "bio": {
          "type": ["string", "null"],
          "maxLength": 500,
          "description": "Short biography (max 500 chars)"
        },
        "consistency_score": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100,
          "description": "Gamification metric calculated by StreakEngine"
        },
        "streak_days": {
          "type": "integer",
          "minimum": 0,
          "description": "Current consecutive days of habit completion"
        },
        "created_at": {
          "type": "string",
          "format": "date-time",
          "description": "ISO8601 timestamp of profile creation"
        },
        "updated_at": {
          "type": "string",
          "format": "date-time",
          "description": "ISO8601 timestamp of last update"
        }
      },
      "required": ["id", "username", "consistency_score", "streak_days", "created_at", "updated_at"]
    },

    "ProfileUpdate": {
      "type": "object",
      "description": "Fields allowed for profile update. All fields optional.",
      "properties": {
        "username": {
          "type": "string",
          "minLength": 3,
          "maxLength": 30,
          "pattern": "^[a-zA-Z0-9_]+$"
        },
        "full_name": {
          "type": ["string", "null"],
          "maxLength": 100
        },
        "avatar_url": {
          "type": ["string", "null"],
          "format": "uri"
        },
        "bio": {
          "type": ["string", "null"],
          "maxLength": 500
        }
      },
      "additionalProperties": false
    }
  }
}
